###### XXX


    # SSL SETTINGS(with SPDY 2)
    #   ssl on;
    #   listen 443 ssl spdy; 
    #   ssl_session_timeout        15m;
    #   ssl_protocols              SSLv3 TLSv1 TLSv1.1 TLSv1.2;
    #   ssl_ciphers                RC4:HIGH:!aNULL:!MD5;
    #   ssl_prefer_server_ciphers  on;
    #   ssl_session_cache          shared:SSL:10m;

    ##  BASIC SSL CERTIFICATE (TEMPORARY)
    #  ssl_certificate /usr/share/nginx/ssl-certs/nutraxen_com/nutraxen_basic.crt;
    ##  EXTENDED VALIDATION CERTIFICATE (GREEN BAR)
    #  ssl_certificate /usr/share/nginx/ssl-certs/nutraxen_com/nutraxen_ev.crt;  
    #  SSL KEY
    #  ssl_certificate_key /usr/share/nginx/ssl-certs/nutraxen_com/nutraxen.com.key;

    # HEADERS FOR STRICT SSL
    # add_header                Strict-Transport-Security "max-age=16070400; includeSubdomains";


    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    # nginx site configuration
    # https://www.decalicious.com
    # www-decalicious-com.conf
    # With EV CERTIFICATE! 
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~




    # -------------------------------------
    #     TYPO DOMAIN NAMES - REDIRECT    -
    #--------------------------------------
    server {
      listen      80;
      server_name dec.al decalciious.net decalishus.com;
      # REDIRECT TO http://www.decalicious.com
      rewrite ^ http://www.decalicious.com$request_uri? permanent;
      # NO LOGGING
      access_log          /dev/null;
      error_log           /dev/null;
    }





    # -------------------------------------------
    #          BACKEND IIS SERVER FARM          -
    # -------------------------------------------
    upstream iis-servers-decalicious {

     # STICKY IP (SAME SERVER BASED ON IP)
     ip_hash;

     # UPSTREAM IIS SERVERS (Add More As Needed)
     server ww1.decalicious.com;
     #server ww2.decalicious.com;
     #server ww3.decalicious.com;
     #server ww4.decalicious.com;
     #server ww5.decalicious.com;

     # HEALTH CHECK SETTINGS (Milisecond Intervals) > https://github.com/yaoweibin/nginx_upstream_check_module
     check interval=50000 rise=1 fall=2 timeout=2500 type=http;
     check_http_send "GET /iis-health/default.asp HTTP/1.0\r\nHost: decalicious.com\r\n\r\n";
     check_http_expect_alive http_2xx http_3xx;
   }





   # ----------------------------------------------------------
   #       DECALICIOUS.com (with any subdomain)
   # ----------------------------------------------------------
   server {

    # SERVER SPECIFIC SETTINGS
    listen                80;
    server_name           *.decalicious.com;
    root                  /usr/share/nginx/sites/decalicious-down/;
    keepalive_timeout     5s;
    allow                 all;
    server_tokens         off; 
    more_clear_headers    'Cache-Control';
    
    # IIS FARM DASHBOARD  //www.decalicious.com/iis-servers-decalicoius
    location /dashboard/nginx {
      check_status;
      access_log   off;
      allow all;
    }


    # MAIN SITE LOCATION (NO CACHING)
    location / {

      more_set_headers          "Server: DECALS";
      add_header                Cache-Control "public, max-age=9";
      etag                      on;
      expires                   60s;

      # Gzip
      gzip                      on;
      gzip_vary                 on;
      gzip_http_version         1.0;
      gzip_disable              "MSIE [1-6].(?!.*SV1)";
      gzip_min_length           750;
      gzip_buffers              64 8k;
      gzip_comp_level           3;
      gzip_proxied              any;
      gzip_types                text/plain text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript;
      
      # Cache File Information
      #open_file_cache           max=1000 inactive=500s;
      #open_file_cache_valid     600s;
      #open_file_cache_errors    on;

      # PROXY SETTINGS
      proxy_redirect            off;
      proxy_set_header          Host              $http_host;
      proxy_set_header          X-Real-IP         $remote_addr;
      proxy_set_header          X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header          X-Forwarded-Proto $scheme;
      proxy_pass                http://iis-servers-decalicious;
      proxy_temp_path           /usr/share/nginx/temp;
      #proxy_connect_timeout    5;
      #proxy_read_timeout       240;

      # PROXY CACHING
      proxy_cache            off;

      #HTTP ERRORS LOCALLY 
      proxy_intercept_errors on; 
      error_page 500 502 503 504 =503 /maintenance.html;
      #error_page 404 =404 /404.html;      
    }


   # ----------------------------------------------------------
   #       www.Decalicious.com/Blog (Reverse Proxy Blogger)
   # ----------------------------------------------------------
    location ~* ^/blog(.*) {

      # Add Trailing Slash to Blog
      if ($request_uri ~* "^/blog")
      {
        rewrite ^(.*[^/])$ $1/ permanent;
      }

      # Make sure blog is only available under www domain
      if ( $host != 'www.decalicious.com' ) {
        rewrite ^/(.*)$ http://www.decalicious.com/$1 permanent;
      }

      # Rewrite outbound text to new url
      subs_filter               blog.decalicious.com/ www.decalicious.com/blog/;

      # Variables so we can redirect later
      set $blog_url            'blog.decalicious.com';
      set $url_full            '$1';


      # HEADERS
      more_set_headers          "Server: DECALS-BL";
      add_header                Cache-Control "public, max-age=9";
      etag                      on;
      expires                   60s;
      
      # Cache File Information
      open_file_cache           max=1000 inactive=500s;
      open_file_cache_valid     600s;
      open_file_cache_errors    on;

      # Gzip
      gzip                      on;
      gzip_vary                 on;
      gzip_http_version         1.0;
      gzip_disable              "MSIE [1-6].(?!.*SV1)";
      gzip_min_length           200;
      gzip_buffers              64 8k;
      gzip_comp_level           3;
      gzip_proxied              any;
      gzip_types                text/plain text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript;
 

      # PROXY SETTINGS
      proxy_set_header          Accept-Encoding "";
      proxy_http_version        1.1;
      proxy_redirect            off;
      proxy_set_header          Host $blog_url;
      proxy_set_header          Authorization '';
      proxy_hide_header         Set-Cookie;
      proxy_ignore_headers      "Set-Cookie";
      proxy_buffering           off;
      resolver                  8.8.4.4 8.8.8.8 valid=300s;
      resolver_timeout          10s;
      proxy_pass                http://$blog_url/$url_full;
      proxy_temp_path           /usr/share/nginx/temp;


      # PROXY CACHING
      proxy_cache               off;

      #HTTP ERRORS LOCALLY 
      proxy_intercept_errors on; 
      error_page 500 502 503 504 =503 /maintenance.html;
      #error_page 404 =404 /404.html;      
      break;
    }

   # ----------------------------------------------------------
   #       www.Decalicious.com/x (Static Content | NO CDN)
   # ----------------------------------------------------------
    #location /x/ {
    location ~ /(x/|app/|favicon.ico/) {


      # HEADERS
      more_set_headers          "Server: DECALS-X";
      add_header                Cache-Control "no-transform,public,max-age=36720000";
      etag                      on;
      expires                   425d;
      
      # Cache File Information
      open_file_cache           max=1000 inactive=500s;
      open_file_cache_valid     600s;
      open_file_cache_errors    on;

      # Gzip
      gzip                      on;
      gzip_vary                 on;
      gzip_http_version         1.0;
      gzip_disable              "MSIE [1-6].(?!.*SV1)";
      gzip_min_length           200;
      gzip_buffers              64 8k;
      gzip_comp_level           3;
      gzip_proxied              any;
      gzip_types                text/plain text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript;
 

      # PROXY SETTINGS
      proxy_http_version        1.1;
      proxy_redirect            off;
      proxy_set_header          Host              $http_host;
      proxy_set_header          X-Real-IP         $remote_addr;
      proxy_set_header          X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header          X-Forwarded-Proto $scheme;
      proxy_pass                http://iis-servers-decalicious;
      proxy_temp_path           /usr/share/nginx/temp;
      #proxy_connect_timeout    5;
      #proxy_read_timeout       240;

      # PROXY CACHING
      proxy_cache               STATIC;
      proxy_cache_valid         200 302 1d;
      proxy_cache_valid         404     1m;
      proxy_cache_use_stale     error timeout invalid_header updating
      http_500 http_502 http_503 http_504;

      #HTTP ERRORS LOCALLY 
      proxy_intercept_errors on; 
      error_page 500 502 503 504 =503 /maintenance.html;
      #error_page 404 =404 /404.html;      
      break;
    }


   # ----------------------------------------------------------
   #       www.Decalicious.com/s3 (Static Content Amazon S3)
   # ----------------------------------------------------------
    location ~* ^/s3/(.*) {


      # Headers based on file extensions

      location ~* ^.+.(svg|gif)$  
        more_clear_headers      'Content-Type';
        more_set_headers        "Content-Type:image/svg+xml";
        more_set_headers        "X-Content-Type:OverRidden-SVG";
      
      location ~* ^.+.(jpg|jpeg|gif|css|png|js|ico|txt|xml)$  
        more_clear_headers      'Content-Type';
        more_set_headers        "Content-Type:image/jpg";
        more_set_headers        "X-Content-Type:OverRidden-JPG";
      
      



      set $s3_bucket           'decalicious.s3.amazonaws.com';
      set $url_full            '$1';

      # HEADERS
      more_set_headers          "Server: DECALS-S3";
      add_header                Cache-Control "no-transform,public,max-age=36720000";
      etag                      on;
      expires                   425d;
      
      # Cache File Information
      open_file_cache           max=1000 inactive=500s;
      open_file_cache_valid     600s;
      open_file_cache_errors    on;

      # Gzip
      gzip                      on;
      gzip_vary                 on;
      gzip_http_version         1.0;
      gzip_disable              "MSIE [1-6].(?!.*SV1)";
      gzip_min_length           200;
      gzip_buffers              64 8k;
      gzip_comp_level           3;
      gzip_proxied              any;
      gzip_types                text/plain text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript font/ttf font/opentype application/vnd.ms-fontobject image/svg+xml;
 

      # PROXY SETTINGS
      proxy_set_header          Accept-Encoding "";
      proxy_http_version        1.1;
      proxy_redirect            off;
      proxy_set_header          Host $s3_bucket;
      proxy_set_header          Authorization '';

      proxy_hide_header         x-amz-id-2;
      proxy_hide_header         x-amz-request-id;
      proxy_hide_header         x-amz-meta-tag;
      proxy_hide_header         x-amz-meta-uuid;
      
      proxy_hide_header         Set-Cookie;
      proxy_ignore_headers      "Set-Cookie";
      proxy_buffering           off;
      resolver                  8.8.4.4 8.8.8.8 valid=300s;
      resolver_timeout          10s;
      proxy_pass                http://$s3_bucket/$url_full;
      proxy_temp_path           /usr/share/nginx/temp;


      # PROXY CACHING
      proxy_cache               STATIC;
      proxy_cache_valid         200 302 1d;
      proxy_cache_valid         404     1m;
      proxy_cache_use_stale     error timeout invalid_header updating
      http_500 http_502 http_503 http_504;

      #HTTP ERRORS LOCALLY 
      proxy_intercept_errors on; 
      error_page 500 502 503 504 =503 /maintenance.html;
      #error_page 404 =404 /404.html;      
      break;
    }




    # ERROR PAGE - DOWN FOR MAINTENANCE
    location  ^~ /maintenance.html {
      root   /usr/share/nginx/sites/decalicious-down/;
      index  maintenance.html index.html index.htm;
      allow all;
    }


    # EROR PAGE - LOCAL 404 PAGE
    location  ^~ /404.html {
      root   /usr/share/nginx/sites/decalicious-down/;
      index  404.html index.html index.htm;
      allow all;
    }

    # LOCAL ERROR PAGE SCRIPTS AND IMAGES (XS Directory)
    location /xs {
      root   /usr/share/nginx/sites/decalicious-down/;
      allow  all;    	
   }

   # ERROR PAGES (LOCAL)
   error_page 404  /usr/share/nginx/sites/decalicious-down/404.html;
   error_page 500 502 503 504 =503 /usr/share/nginx/sites/decalicious-down/maintenance.html;


   # NO LOGGING
   access_log          /dev/null;
   error_log           /dev/null;
   # DEBUG LOGGING
   #error_log           /var/log/nginx/decalicious.com.error.log ;
   #access_log          /var/log/nginx/decalicious.com.log ;
 }








