# ---------------------------------------------------
#     CUSTOM BACKEND TO HANDLE PHP REQUESTS
#-----------------------------------------------------
upstream phpBackend {
  server 127.0.0.1:9000;
}





# ---------------------------------------------------
#     CLOUDAPP AZURE SERVER *.CLOUDAPP.NET
#-----------------------------------------------------
server {
  listen      80 default_server;
  server_name *.cloudapp.net;
  root   /usr/share/nginx/sites/wwwroot/;
  index  index.php index.html index.htm;
  keepalive_timeout     5s;
  allow                 all;
  server_tokens         off; 
  more_clear_headers    'Cache-Control';


  location / {
    try_files $uri $uri/ /index.html;
    allow all;
  }
  error_page   404  /404.html;
  location = /usr/share/nginx/sites/wwwroot/404.html {
    root   html;
    allow all;
  }
  error_page   500 502 503 504  /error.html;
    location = /usr/share/nginx/sites/wwwroot/error.html {
    root   html;
    allow all;
  }

  # PHP Files Handled Locally Via NGINX 
  # This will allow us to use git hooks to update the nginx config..
  location ~ \.php$ {
    try_files                       $uri =404;
    fastcgi_split_path_info         ^(.+\.php)(/.+)$;
    fastcgi_pass                    phpBackend;
    fastcgi_index                   index.php;
    # IMPORTANT BELOW - NEEDS FULL PATH TO SITE DIRECTORY !!!
    fastcgi_param                   SCRIPT_FILENAME  /usr/share/nginx/sites/wwwroot/$fastcgi_script_name;
    include                         fastcgi_params;
    fastcgi_intercept_errors        on;
    fastcgi_ignore_client_abort     off;
    fastcgi_connect_timeout         60;
    fastcgi_send_timeout            180;
    fastcgi_read_timeout            180;
    fastcgi_buffer_size             128k;
    fastcgi_buffers                 4 256k;
    fastcgi_busy_buffers_size       256k;
    fastcgi_temp_file_write_size    256k;
  }

  # Logging - Off
  access_log          /dev/null;
  error_log           /dev/null;
}






# ------------------------------------------
#     AZURE TRAFFIC MANAGER MONITORING PAGE
#-------------------------------------------
server {
  listen      100 default_server;
  #server_name *.cloudapp.net;

  # Actual Page
  location / {
   root   /usr/share/nginx/sites/wwwroot/status/;
   index  index.html;
   allow all;
   gzip                      on;
   gzip_vary                 on;
 }

 # Turn off logging
 access_log          /dev/null;
 error_log           /dev/null;

 # Logging - ON
 #error_log        /var/log/nginx/default-error.log;
 #access_log       /var/log/nginx/default-access.log;


}

